<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuentas por Cobrar - Canal Internacional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="/static/css/main.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <!-- Header estilo Dashboard amplio -->
  <div class="dashboard-header">
    <div class="header-left">
      <div class="header-info">
        <h1>CUENTAS POR COBRAR - CANAL INTERNACIONAL</h1>
      </div>
    </div>
    <div class="header-nav">
      <a href="/reporte_cta_12_13" class="btn-nav"><i class="bi bi-file-text"></i> Reportes</a>
      <a href="/auth/logout" class="btn-salir"><i class="bi bi-box-arrow-right"></i> Salir</a>
    </div>
  </div>
  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator">
    <div class="loading-spinner"></div>
    <div>Cargando KPIs del canal internacional...</div>
  </div>

  <div class="container py-4">
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Desde</label>
            <input type="date" class="form-control" id="start" />
          </div>
          <div class="col-sm-3">
            <label class="form-label">Hasta</label>
            <input type="date" class="form-control" id="end" />
          </div>
          <div class="col-sm-2">
            <button class="btn btn-primary w-100" id="btnFiltrar" type="button">Aplicar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <div class="fw-bold">Total facturas</div>
            <div id="kpi-total" class="fs-3">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <div class="fw-bold">Monto vencido</div>
            <div id="kpi-vencido" class="fs-3">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <div class="fw-bold">Monto vigente</div>
            <div id="kpi-vigente" class="fs-3">-</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-bg-light">
          <div class="card-body">
            <div class="fw-bold">Prom. días morosidad</div>
            <div id="kpi-morosidad" class="fs-3">-</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card">
          <div class="card-header">Balance de Cartera (Dona) y Deuda por Tipo de Documento</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6"><div id="echartsDonut" style="height:180px"></div></div>
              <div class="col-md-6"><canvas id="tipoDocChart" height="180"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-12">
        <div class="card">
          <div class="card-header">Cartera de Clientes - Deuda Top 10</div>
          <div class="card-body">
            <canvas id="top10Chart" height="260"></canvas>
            <div class="table-responsive mt-4">
              <table class="table table-sm table-striped align-middle" id="tblTop15">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Documento</th>
                    <th>Fecha</th>
                    <th>Vence</th>
                    <th class="text-end">Monto</th>
                    <th class="text-end">Saldo</th>
                    <th>Origen</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    async function loadKpis(){
      const qs = buildQuery();
      const res = await fetch('/api/kpis' + (qs?('?' + qs):''));
      if(!res.ok) return;
      const data = await res.json();
      const fmt = (n)=> new Intl.NumberFormat('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n||0);
      document.getElementById('kpi-total').textContent = data.total_facturas;
      document.getElementById('kpi-vencido').textContent = fmt(data.monto_vencido);
      document.getElementById('kpi-vigente').textContent = fmt(data.monto_vigente);
      document.getElementById('kpi-morosidad').textContent = fmt(data.promedio_dias_morosidad);
      renderDonut(data.monto_vigente, data.monto_vencido);
      renderTipoDoc(data.tipo_documento.labels, data.tipo_documento.values);
      renderTop10(data.top10.labels, data.top10.values);
      renderMorosidad(data.morosidad_series.labels, data.morosidad_series.values);
    }

    function renderDonut(vigente, vencido){
      const el = document.getElementById('echartsDonut');
      const chart = echarts.init(el);
      chart.setOption({
        tooltip:{ trigger:'item', formatter:'{b}: {c} ({d}%)' },
        series:[{ type:'pie', radius:['50%','70%'], avoidLabelOverlap:false,
          label:{ show:false }, emphasis:{ label:{ show:true, fontSize:14, fontWeight:'bold' } },
          data:[{value:vigente, name:'Vigente'},{value:vencido, name:'Vencido'}],
          color:['#198754','#dc3545']
        }]
      });
    }

    function renderTipoDoc(labels, values){
      const ctx = document.getElementById('tipoDocChart');
      new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data: values, backgroundColor:'#0dcaf0' }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
    }
    function renderMorosidad(labels, values){
      const container = document.createElement('div');
      container.className = 'card mt-3';
      container.innerHTML = '<div class="card-header">Evolución del Índice de Morosidad (%)</div><div class="card-body"><div id="morosidadChart" style="height:120px"></div></div>';
      document.querySelector('.container').appendChild(container);
      const ctx = document.getElementById('morosidadChart');
      Plotly.newPlot(ctx, [{ x: labels, y: values, type:'scatter', mode:'lines+markers', line:{color:'#dc3545'} }], { margin:{t:10}, yaxis:{ title:'%'} }, {displayModeBar:false});
    }

    async function loadTop15(){
      const qs = buildQuery();
      const res = await fetch('/api/reports/top15' + (qs?('?' + qs):''));
      if(!res.ok) return;
      const data = await res.json();
      renderTop15Chart(data.clientes || [], data.montos || []);
      // cargar detalle
      const det = await fetch('/api/reports/top15/details' + (qs?('?' + qs):''));
      if(det.ok){
        const j = await det.json();
        renderTop15Table(j.rows || []);
      }
    }

    function buildQuery(){
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const p = new URLSearchParams();
      if(start) p.set('start', start);
      if(end) p.set('end', end);
      return p.toString();
    }

    function renderTop10(labels, values){
      const ctx = document.getElementById('top10Chart');
      new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ data: values, backgroundColor: values.map(v=> v>0? '#0d6efd':'#6c757d') }] }, options:{ indexAxis:'y', responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ beginAtZero:true } } } });
    }

    function renderTop15Table(rows){
      const tbody = document.querySelector('#tblTop15 tbody');
      tbody.innerHTML = '';
      const fmt = (n)=> new Intl.NumberFormat('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n||0);
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.cliente||''}</td>
          <td>${r.documento||''}</td>
          <td>${r.fecha||''}</td>
          <td>${r.vence||''}</td>
          <td class="text-end">${fmt(r.monto)}</td>
          <td class="text-end fw-semibold">${fmt(r.saldo)}</td>
          <td>${r.origen||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // =============== FUNCIONALIDAD INTERACTIVA MEJORADA ===============
    
    // Loading indicator management
    function showLoading() {
      document.getElementById('loading-indicator').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading-indicator').style.display = 'none';
    }
    
    // Enhanced loadKpis with loading states
    const originalLoadKpis = loadKpis;
    loadKpis = async function() {
      showLoading();
      try {
        await originalLoadKpis();
      } finally {
        setTimeout(hideLoading, 300); // Pequeño delay para mejor UX
      }
    };
    
    // Enhanced loadTop15 with loading states
    const originalLoadTop15 = loadTop15;
    loadTop15 = async function() {
      try {
        await originalLoadTop15();
      } catch (error) {
        console.error('Error cargando Top 15:', error);
      }
    };
    
    // Auto-hide loading on page load
    window.addEventListener('load', function() {
      hideLoading();
    });
    
    // Enhanced filter button with loading feedback
    document.getElementById('btnFiltrar').addEventListener('click', function() {
      showLoading();
      this.disabled = true;
      this.textContent = 'Cargando...';
      
      Promise.all([loadKpis(), loadTop15()]).finally(() => {
        this.disabled = false;
        this.textContent = 'Aplicar';
      });
    });
    
    // Initialize with loading
    showLoading();
    Promise.all([loadKpis(), loadTop15()]).finally(() => {
      hideLoading();
    });
  </script>
</body>
</html>

