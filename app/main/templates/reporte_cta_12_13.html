<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuenta por Cobrar 12 y 13</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="/static/css/main.css" rel="stylesheet" />
</head>
<body>
  <!-- Header estilo Dashboard amplio -->
  <div class="dashboard-header">
    <div class="header-left">
      <div class="header-info">
        <h1>CUENTA POR COBRAR 12 Y 13</h1>
      </div>
    </div>
    <div class="header-nav">
      <a href="#" onclick="exportExcelWithLoading()" class="btn-nav"><i class="bi bi-file-earmark-excel"></i> Exportar</a>
      <a href="/dashboard_internacional" class="btn-nav"><i class="bi bi-speedometer2"></i> Dashboard</a>
      <a href="/auth/logout" class="btn-salir"><i class="bi bi-box-arrow-right"></i> Salir</a>
    </div>
  </div>
  <!-- Loading Indicator -->
  <div id="loading-indicator" class="loading-indicator">
    <div class="loading-spinner"></div>
    <div>Cargando datos de TODOS los canales...</div>
  </div>

  <div class="container reports-container">
    <div class="filter-bar">
      <div class="filter-bar__content">
        <form id="filtros" class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Desde</label>
            <input type="date" class="form-control" id="start" />
          </div>
          <div class="col-sm-3">
            <label class="form-label">Hasta</label>
            <input type="date" class="form-control" id="end" />
          </div>
          <div class="col-sm-4">
            <label class="form-label">Cliente</label>
            <input type="text" class="form-control" id="q" placeholder="Nombre, RUC, etc." />
          </div>
          <div class="col-sm-4">
            <label class="form-label">Cuentas (coma-separadas)</label>
            <input type="text" class="form-control" id="accounts" placeholder="1212,122,1312,132" />
          </div>
          <div class="col-sm-2">
            <label class="form-label">Resultados</label>
            <select class="form-select" id="per_page">
              <option value="100">100</option>
              <option value="500" selected>500</option>
              <option value="1000">1,000</option>
            </select>
          </div>
          <div class="col-sm-2 text-end">
            <button class="btn btn-primary w-100" id="btnBuscar" type="button">Buscar</button>
          </div>
          <div class="col-sm-2">
            <button class="btn btn-outline-secondary w-100" id="btnLimpiar" type="button">
              <i class="bi bi-arrow-clockwise"></i> Limpiar
            </button>
          </div>
          <div class="col-sm-3 ms-auto">
            <div id="pager-top" class="text-end"></div>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle" id="tblReport" style="font-size: 0.9rem;">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo de Documento</th>
                <th>Número</th>
                <th>Origen</th>
                <th>Cuenta</th>
                <th>Nombre de cuenta</th>
                <th>DNI/RUC</th>
                <th>Cliente</th>
                <th>Monto</th>
                <th>Monto residual</th>
                <th>Fecha de vencimiento</th>
                <th>Referencia</th>
                <th>Etiqueta</th>
                <th>Vendedor</th>
                <th>Provincia</th>
                <th>Distrito</th>
                <th>Dirección completa</th>
                <th>Código de país</th>
                <th>País</th>
                <th>Canal de venta</th>
                <th>Tipo de venta</th>
                <th>Estado de Pago</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const columns = [
      { key: 'date', label: 'Fecha' },
      { key: 'I10nn_latam_document_type_id', label: 'Tipo de Documento' },
      { key: 'move_name', label: 'Número' },
      { key: 'invoice_origin', label: 'Origen' },
      { key: 'account_id/code', label: 'Cuenta/Código' },
      { key: 'account_id/name', label: 'Cuenta/Nombre' },
      { key: 'patner_id/vat', label: 'Socio/NIF' },
      { key: 'patner_id', label: 'Socio' },
      { key: 'amount_currency', label: 'Importe en moneda' },
      { key: 'amount_residual_currency', label: 'Importe residual en moneda' },
      { key: 'date_maturity', label: 'Fecha de vencimiento' },
      { key: 'ref', label: 'Referencia' },
      { key: 'name', label: 'Etiqueta' },
      { key: 'move_id/invoice_user_id', label: 'Asiento/Vendedor' },
      { key: 'patner_id/state_id', label: 'Socio/Provincia' },
      { key: 'patner_id/l10n_pe_district', label: 'Socio/Distrito' },
      { key: 'patner_id/contact_adress', label: 'Socio/Dirección completa' },
      { key: 'patner_id/country_code', label: 'Socio/Código de país' },
      { key: 'patner_id/country_id', label: 'Socio/País' },
      { key: 'move_id/sales_channel_id', label: 'Asiento/Canal de venta' },
      { key: 'move_id/sales_type_id', label: 'Asiento/Tipo de venta' },
      { key: 'move_id/payment_state', label: 'Estado de Pago' }
    ];
    function buildQuery(){
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const q = document.getElementById('q').value;
      const accounts = document.getElementById('accounts') ? document.getElementById('accounts').value : '';
      const per_page = document.getElementById('per_page') ? document.getElementById('per_page').value : '500';
      const page = window.reportPage || 1;
      const p = new URLSearchParams();
      if(start) p.set('start', start);
      if(end) p.set('end', end);
      if(q) p.set('q', q);
      if(accounts) p.set('accounts', accounts);
      p.set('page', page);
      p.set('per_page', per_page);
      // Actualizar variable global
      window.reportPerPage = parseInt(per_page);
      return p.toString();
    }
    async function loadData(){
      const qs = buildQuery();
      const res = await fetch('/api/reports/data' + (qs?('?' + qs):''));
      if(!res.ok) return;
      const data = await res.json();
      renderRows(data.rows || []);
      renderPager(data.total || 0, data.page || 1, data.per_page || 100);
      const excel = '/api/reports/export.xlsx' + (qs?('?' + qs):'');
      document.getElementById('btnExcel').setAttribute('href', excel);
    }
    function renderPager(total, page, perPage){
      window.reportPage = page; window.reportPerPage = perPage;
      const pages = Math.max(1, Math.ceil(total / perPage));
      const windowSize = 15;
      let start = Math.max(1, page - Math.floor(windowSize/2));
      let end = Math.min(pages, start + windowSize - 1);
      if (end - start + 1 < windowSize) start = Math.max(1, end - windowSize + 1);
      let html = '';
      for(let i=start;i<=end;i++){
        html += `<li class="page-item ${i===page?'active':''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
      }
      const nav = document.getElementById('pager');
      nav.innerHTML = `<nav><ul class="pagination pagination-sm">${html}</ul></nav>`;
      const navTop = document.getElementById('pager-top');
      if(navTop){ navTop.innerHTML = `<nav><ul class="pagination pagination-sm justify-content-end">${html}</ul></nav>`; }
      nav.querySelectorAll('a[data-page]').forEach(a=>{
        a.addEventListener('click', e=>{ e.preventDefault(); window.reportPage=parseInt(a.dataset.page); loadData(); });
      });
      if(navTop){ navTop.querySelectorAll('a[data-page]').forEach(a=>{
        a.addEventListener('click', e=>{ e.preventDefault(); window.reportPage=parseInt(a.dataset.page); loadData(); });
      }); }
    }
    function renderRows(rows){
      const tb = document.querySelector('#tblReport tbody');
      tb.innerHTML = '';
      const fmt = (n)=> new Intl.NumberFormat('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n||0);
      
      // Ajustar altura de tabla según número de resultados
      const tableContainer = document.querySelector('.table-responsive');
      const rowCount = rows.length;
      
      if (rowCount <= 5) {
        tableContainer.style.maxHeight = '40vh';
        tableContainer.style.minHeight = '250px';
      } else if (rowCount <= 15) {
        tableContainer.style.maxHeight = '55vh';
        tableContainer.style.minHeight = '400px';
      } else if (rowCount <= 50) {
        tableContainer.style.maxHeight = '65vh';
        tableContainer.style.minHeight = '500px';
      } else {
        tableContainer.style.maxHeight = '75vh';
        tableContainer.style.minHeight = '600px';
      }
      
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = columns.map(c=>{
          let v = r[c.key] ?? '';
          if(['amount_currency','amount_residual_currency'].includes(c.key)){
            v = fmt(v);
            return `<td class=\"text-end\">${v}</td>`;
          }
          return `<td>${v||''}</td>`;
        }).join('');
        tb.appendChild(tr);
      });
      
      // Mostrar información de resultados
      updateResultsInfo(rows.length);
    }
    
    // Función para mostrar información de resultados
    function updateResultsInfo(count) {
      const container = document.querySelector('.filter-bar');
      let infoDiv = container.querySelector('.results-info');
      
      if (!infoDiv) {
        infoDiv = document.createElement('div');
        infoDiv.className = 'results-info mt-3';
        container.appendChild(infoDiv);
      }
      
      const perPage = document.getElementById('per_page').value;
      const emoji = count >= perPage ? '📊' : count > 0 ? '✅' : '❌';
      
      infoDiv.innerHTML = `
        <strong>${emoji} Resultados de TODOS los Canales:</strong> 
        ${count} registros mostrados
        ${count >= perPage ? `(mostrando primeros ${perPage})` : ''}
      `;
    }
    // =============== FUNCIONALIDAD INTERACTIVA (Inspirada en sales.html) ===============
    
    // Loading indicator management
    function showLoading() {
      document.getElementById('loading-indicator').style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading-indicator').style.display = 'none';
    }
    
    // Enhanced loadData with loading states
    const originalLoadData = loadData;
    loadData = async function() {
      showLoading();
      try {
        await originalLoadData();
      } finally {
        hideLoading();
      }
    };
    
    // Auto-hide loading on page load
    window.addEventListener('load', function() {
      hideLoading();
    });
    
    // Scroll optimization for large datasets
    let ticking = false;
    function handleScroll() {
      if (!ticking) {
        requestAnimationFrame(function() {
          const scrollHeight = document.documentElement.scrollHeight;
          const scrollTop = document.documentElement.scrollTop;
          const clientHeight = document.documentElement.clientHeight;
          
          // Preload optimization when user is near bottom
          if (scrollTop + clientHeight > scrollHeight * 0.8) {
            console.log('🚀 Usuario cerca del final, optimizando carga...');
          }
          ticking = false;
        });
        ticking = true;
      }
    }
    
    window.addEventListener('scroll', handleScroll);
    
    // Enhanced form submission with loading state
    document.getElementById('btnBuscar').addEventListener('click', function() {
      showLoading();
      loadData();
    });
    
    // Botón limpiar con funcionalidad completa
    document.getElementById('btnLimpiar').addEventListener('click', function() {
      // Limpiar todos los campos del formulario
      document.getElementById('start').value = '';
      document.getElementById('end').value = '';
      document.getElementById('q').value = '';
      document.getElementById('accounts').value = '';
      document.getElementById('per_page').value = '500';
      
      // Resetear variables globales
      window.reportPage = 1;
      window.reportPerPage = 500;
      
      // Limpiar la tabla
      const tbody = document.querySelector('#tblReport tbody');
      tbody.innerHTML = '';
      
      // Limpiar paginación y quitar clase active
      const pager = document.getElementById('pager');
      const pagerTop = document.getElementById('pager-top');
      if (pager) pager.innerHTML = '';
      if (pagerTop) pagerTop.innerHTML = '';
      
      // Quitar todas las clases "active" de paginación
      document.querySelectorAll('.page-item.active').forEach(item => {
        item.classList.remove('active');
      });
      
      // Limpiar información de resultados
      const resultsInfo = document.querySelector('.results-info');
      if (resultsInfo) resultsInfo.remove();
      
      // Resetear altura de tabla
      const tableContainer = document.querySelector('.table-responsive');
      if (tableContainer) {
        tableContainer.style.maxHeight = '70vh';
        tableContainer.style.minHeight = '300px';
      }
      
      // Mostrar mensaje de limpieza
      showLoading();
      setTimeout(() => {
        hideLoading();
        console.log('🧹 Formulario y tabla limpiados correctamente');
      }, 300);
    });
    
    // Auto-reload when changing results per page
    document.getElementById('per_page').addEventListener('change', function() {
      window.reportPage = 1; // Reset to first page
      showLoading();
      loadData();
    });
    
    // Enhanced Excel export with loading feedback (Header button) - Basado en sales.html
    window.exportExcelWithLoading = function() {
      showLoading();
      
      // Obtener filtros actuales como en sales.html
      const start = document.getElementById('start').value || '';
      const end = document.getElementById('end').value || '';
      const q = document.getElementById('q').value || '';
      const accounts = document.getElementById('accounts').value || '';
      const per_page = document.getElementById('per_page').value || '500';
      
      // Construir URL de exportación con parámetros
      const params = new URLSearchParams();
      if (start) params.append('start', start);
      if (end) params.append('end', end);
      if (q) params.append('q', q);
      if (accounts) params.append('accounts', accounts);
      params.append('per_page', per_page);
      
      // URL de exportación
      const exportUrl = `/api/reports/export.xlsx?${params.toString()}`;
      console.log('📊 Exportando CxC 12 y 13 a Excel:', exportUrl);
      
      // Simulate delay for user feedback
      setTimeout(() => {
        // Crear enlace temporal para descarga como en sales.html
        window.location.href = exportUrl;
        hideLoading();
      }, 500);
    };
    
    // Initialize
    loadData();
  </script>
  
  <!-- Pagination Container -->
  <div class="pagination-container">
    <div id="pager" class="d-flex justify-content-center"></div>
  </div>
</body>
</html>

