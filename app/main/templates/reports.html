<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reportes CxC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard">CxC Reporter</a>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-primary" href="/dashboard">Dashboard</a>
        <a class="btn btn-outline-secondary" href="/auth/logout">Salir</a>
      </div>
    </div>
  </nav>
  <div class="container py-3">
    <div class="card mb-3">
      <div class="card-body">
        <form id="filtros" class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Desde</label>
            <input type="date" class="form-control" id="start" />
          </div>
          <div class="col-sm-3">
            <label class="form-label">Hasta</label>
            <input type="date" class="form-control" id="end" />
          </div>
          <div class="col-sm-4">
            <label class="form-label">Cliente</label>
            <input type="text" class="form-control" id="q" placeholder="Nombre, RUC, etc." />
          </div>
          <div class="col-sm-2 text-end">
            <button class="btn btn-primary w-100" id="btnBuscar" type="button">Buscar</button>
          </div>
        </form>
        <div class="mt-3 text-end">
          <a id="btnExcel" class="btn btn-success" href="#">Exportar Excel</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="tblReport">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo de Documento</th>
                <th>Número</th>
                <th>Origen</th>
                <th>Código</th>
                <th>Nombre</th>
                <th>Cod. Cliente SAP</th>
                <th>Ruc</th>
                <th>Cliente</th>
                <th>Monto</th>
                <th>Monto residual</th>
                <th>Fecha de vencimiento</th>
                <th>Referencia</th>
                <th>Etiqueta</th>
                <th>Vendedor</th>
                <th>Provincia</th>
                <th>Distrito</th>
                <th>Dirección completa</th>
                <th>Dirección de destino</th>
                <th>Código de país</th>
                <th>País</th>
                <th>Canal de venta</th>
                <th>Tipo de venta</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const columns = [
      { key: 'date', label: 'Fecha' },
      { key: 'I10nn_latam_document_type_id', label: 'Tipo de Documento' },
      { key: 'move_name', label: 'Número' },
      { key: 'invoice_origin', label: 'Origen' },
      { key: 'account_id/code', label: 'Cuenta/Código' },
      { key: 'account_id/name', label: 'Cuenta/Nombre' },
      { key: 'patner_id/cod_client_sap', label: 'Socio/Cod. Cliente SAP' },
      { key: 'patner_id/vat', label: 'Socio/NIF' },
      { key: 'patner_id', label: 'Socio' },
      { key: 'amount_currency', label: 'Importe en moneda' },
      { key: 'amount_residual_currency', label: 'Importe residual en moneda' },
      { key: 'date_maturity', label: 'Fecha de vencimiento' },
      { key: 'ref', label: 'Referencia' },
      { key: 'name', label: 'Etiqueta' },
      { key: 'move_id/invoice_user_id', label: 'Asiento/Vendedor' },
      { key: 'patner_id/state_id', label: 'Socio/Provincia' },
      { key: 'patner_id/l10n_pe_district', label: 'Socio/Distrito' },
      { key: 'patner_id/contact_adress', label: 'Socio/Dirección completa' },
      { key: 'destiny_adress', label: 'Dirección de destino' },
      { key: 'patner_id/country_code', label: 'Socio/Código de país' },
      { key: 'patner_id/country_id', label: 'Socio/País' },
      { key: 'move_id/sales_channel_id', label: 'Asiento/Canal de venta' },
      { key: 'move_id/sales_type_id', label: 'Asiento/Tipo de venta' }
    ];
    function buildQuery(){
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const q = document.getElementById('q').value;
      const p = new URLSearchParams();
      if(start) p.set('start', start);
      if(end) p.set('end', end);
      if(q) p.set('q', q);
      return p.toString();
    }
    async function loadData(){
      const qs = buildQuery();
      const res = await fetch('/api/reports/data' + (qs?('?' + qs):''));
      if(!res.ok) return;
      const data = await res.json();
      renderRows(data.rows || []);
      const excel = '/api/reports/export.xlsx' + (qs?('?' + qs):'');
      document.getElementById('btnExcel').setAttribute('href', excel);
    }
    function renderRows(rows){
      const tb = document.querySelector('#tblReport tbody');
      tb.innerHTML = '';
      const fmt = (n)=> new Intl.NumberFormat('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n||0);
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = columns.map(c=>{
          let v = r[c.key] ?? '';
          if(['amount_currency','amount_residual_currency'].includes(c.key)){
            v = fmt(v);
            return `<td class=\"text-end\">${v}</td>`;
          }
          return `<td>${v||''}</td>`;
        }).join('');
        tb.appendChild(tr);
      });
    }
    document.getElementById('btnBuscar').addEventListener('click', loadData);
    loadData();
  </script>
</body>
</html>

